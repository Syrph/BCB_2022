
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Macroecology analyses &#8212; Biodiversity and Conservation Biology</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Setting conservation priorities" href="../practical_4/practical_4.html" />
    <link rel="prev" title="Phylogenetics in R" href="../practical_2/practical_2.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Biodiversity and Conservation Biology</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   Introduction
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../practical_1/practical_1.html">
   Basics in R
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../practical_2/practical_2.html">
   Phylogenetics in R
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Macroecology analyses
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../practical_4/practical_4.html">
   Setting conservation priorities
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../links.html">
   Useful links
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/markdowns/practical_3/practical_3.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction-and-resources">
   1. Introduction and resources
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#linear-models">
   2. Linear models
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#phylogenetic-generalised-least-squares-models">
   3. Phylogenetic generalised least squares models
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rapoports-rule">
   4. Rapoportâ€™s rule
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#phylogenetic-analysis">
     Phylogenetic analysis
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plotting-range-size">
     Plotting range size
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#latitudinal-diversity-gradient">
   5. Latitudinal diversity gradient
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generalised-linear-models">
     Generalised linear models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plotting-species-richness">
     Plotting species richness
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <section id="macroecology-analyses">
<h1>Macroecology analyses<a class="headerlink" href="#macroecology-analyses" title="Permalink to this headline">Â¶</a></h1>
<section id="introduction-and-resources">
<h2>1. Introduction and resources<a class="headerlink" href="#introduction-and-resources" title="Permalink to this headline">Â¶</a></h2>
<p>This practical should be a refresher on linear models in <code class="docutils literal notranslate"><span class="pre">R</span></code>, before
introducing you to a phylogenetic least squares model, or a PGLS.
Because species that are closely related often share similar traits,
this means we canâ€™t treat them as statistically independent. However, if
we look at how the traits are spread throughout the tree, we can
â€˜controlâ€™ for this non-independence. Weâ€™ll go into more detail when we
run our PGLS.</p>
</section>
<section id="linear-models">
<h2>2. Linear models<a class="headerlink" href="#linear-models" title="Permalink to this headline">Â¶</a></h2>
<p>For this practical weâ€™ll be working data from the family Anatidae
(ducks) to investigate Bergmannâ€™s rule - if there is a relationship
between latitude and body mass. First, weâ€™ll load in the data and
inspect it:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remember to clear your workspace before starting a new project.</span>
<span class="nf">rm</span><span class="p">(</span><span class="n">list</span><span class="o">=</span><span class="nf">ls</span><span class="p">())</span>

<span class="c1"># Load the duck latitudinal and body mass data.</span>
<span class="n">duck_data</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&quot;data/duck_data.csv&quot;</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span> 

<span class="c1"># Check it&#39;s been imported.</span>
<span class="nf">str</span><span class="p">(</span><span class="n">duck_data</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">duck_data</span><span class="p">)</span>

<span class="c1"># Remove any NAs in the data (make sure to check you&#39;re not loosing too much data!)</span>
<span class="n">duck_data</span> <span class="o">&lt;-</span> <span class="nf">na.omit</span><span class="p">(</span><span class="n">duck_data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>## &#39;data.frame&#39;:    156 obs. of  3 variables:
##  $ jetz_name: chr  &quot;Dendrocygna viduata&quot; &quot;Dendrocygna autumnalis&quot; &quot;Dendrocygna guttata&quot; &quot;Dendrocygna arborea&quot; ...
##  $ latitude : num  -5.68 -5.68 -3.41 19.66 -0.38 ...
##  $ body_mass: num  690 755 800 1150 756 ...
##                jetz_name latitude body_mass
## 1    Dendrocygna viduata    -5.68    689.99
## 2 Dendrocygna autumnalis    -5.68    755.30
## 3    Dendrocygna guttata    -3.41    800.00
## 4    Dendrocygna arborea    19.66   1150.00
## 5    Dendrocygna bicolor    -0.38    756.37
## 6     Dendrocygna eytoni   -21.27    789.99
</pre></div>
</div>
<p>The midpoint latitude is the centre of the distribution of each species.
Because weâ€™re interested in the distance from equator, weâ€™ll use the
<code class="docutils literal notranslate"><span class="pre">abs()</span></code> function to convert our data.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># The abs function takes absolute value.</span>
<span class="n">duck_data</span><span class="o">$</span><span class="n">abs_latitude</span> <span class="o">&lt;-</span> <span class="nf">abs</span><span class="p">(</span><span class="n">duck_data</span><span class="o">$</span><span class="n">latitude</span><span class="p">)</span>
</pre></div>
</div>
<p>Weâ€™ll start by looking at the relationship between body mass and
latitude using a scatter plot.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a basic plot for data visualisation.</span>
<span class="c1"># Notice we can add a data argument instead of using $</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">body_mass</span> <span class="o">~</span> <span class="n">abs_latitude</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">duck_data</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-3-11.png"><img alt="../../_images/unnamed-chunk-3-11.png" class="align-center" src="../../_images/unnamed-chunk-3-11.png" style="width: 600px;" /></a>
<p>Now there doesnâ€™t seem to be much of a relationship at all from our
plot. However, if we remember back to practical 1, body mass is often
logarithmically distributed, with lots of small species and fewer large
ones. Therefore we might not be seeing the true relationship!</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># We&#39;ll use a histogram to look at the spread.</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">duck_data</span><span class="o">$</span><span class="n">body_mass</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-4-11.png"><img alt="../../_images/unnamed-chunk-4-11.png" class="align-center" src="../../_images/unnamed-chunk-4-11.png" style="width: 600px;" /></a>
<p>As we suspected! The histogram suggests a log-normal distribution. If we
take logs we might see a more normal distribution.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a new variable and take logs.</span>
<span class="n">duck_data</span><span class="o">$</span><span class="n">log_BM</span> <span class="o">&lt;-</span> <span class="nf">log</span><span class="p">(</span><span class="n">duck_data</span><span class="o">$</span><span class="n">body_mass</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">duck_data</span><span class="o">$</span><span class="n">log_BM</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-5-11.png"><img alt="../../_images/unnamed-chunk-5-11.png" class="align-center" src="../../_images/unnamed-chunk-5-11.png" style="width: 600px;" /></a>
<p>Now weâ€™ve got some data that resembles a more normal distribution! Letâ€™s
look at the new relationship between the two variables:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a new plot.</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">log_BM</span> <span class="o">~</span> <span class="n">abs_latitude</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">duck_data</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-6-11.png"><img alt="../../_images/unnamed-chunk-6-11.png" class="align-center" src="../../_images/unnamed-chunk-6-11.png" style="width: 600px;" /></a>
<p>Now weâ€™re starting to see some kind of relationship! Thereâ€™s a lot of
spread to the points, but we can see the smallest species at the lowest
latitudes, and the largest at the highest. To really find out if thereâ€™s
a relationship we can test our hypothesis with a linear model.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run a basic linear model. We separate our dependant variables from predictors using a tilda ~</span>
<span class="n">duck_model</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">log_BM</span> <span class="o">~</span> <span class="n">abs_latitude</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">duck_data</span><span class="p">)</span>

<span class="c1"># Inspect our linear model.</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">duck_model</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>## 
## Call:
## lm(formula = log_BM ~ abs_latitude, data = duck_data)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -1.3202 -0.5291 -0.0613  0.3249  2.1978 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  6.505760   0.124237  52.366  &lt; 2e-16 ***
## abs_latitude 0.011639   0.002933   3.969 0.000112 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.725 on 150 degrees of freedom
## Multiple R-squared:  0.09503,    Adjusted R-squared:  0.089 
## F-statistic: 15.75 on 1 and 150 DF,  p-value: 0.0001117
</pre></div>
</div>
<p>Now we can investigate if there is a relationship. Thereâ€™s quite a lot
going on with our output, but for this practical weâ€™ll focus on just a
few main things:</p>
<p><code class="docutils literal notranslate"><span class="pre">Coefficients</span></code>: This tells us about our predictors in the model. In this
one thereâ€™s 2, the intercept, and latitude. Weâ€™ll break each section
down further.</p>
<p><code class="docutils literal notranslate"><span class="pre">Estimate</span></code>: This tells us what mean values of our coefficients should
have. For the intercept this will be the point that crosses the y axis.
For latitude, this will be the gradient of the relationship between
latitude and body mass.</p>
<p><code class="docutils literal notranslate"><span class="pre">Std.</span> <span class="pre">Error</span></code>: This shows how much faith we have in our estimates. Weâ€™re
fairly certain that our estimates will fall within the range: Estimate
+- Standard Error.</p>
<p><code class="docutils literal notranslate"><span class="pre">t</span> <span class="pre">value</span></code>: This is our test statistic. In a linear model weâ€™re testing
if each of our estimated values are significantly different from zero.
If the Estimate +- (2 x Standard Errors) doesnâ€™t overlap zero, it
normally means they are significant.</p>
<p><code class="docutils literal notranslate"><span class="pre">Pr(&gt;|t|)</span></code>: This is our p values for each predictor. This is calculated
by weighing up the degrees of freedom against our test statistic, and
tells us what the chance is that we observed the same pattern in our
data given that there was no relationship, i.e.Â the null hypothesis is
true.</p>
<p><code class="docutils literal notranslate"><span class="pre">Multiple</span> <span class="pre">R-squared</span></code>: This tells us how much of the variation in our
response variable is explained by our model. Large values are better,
but often in macro-evolution we see smaller values. Because traits at a
macro scale are often driven by multiple selection pressures, which may
sometimes be species-specific, we expect less variation to be explained
than in smaller more targeted studies.</p>
<p><code class="docutils literal notranslate"><span class="pre">Adjusted</span> <span class="pre">R</span> <span class="pre">squared</span></code>: This also tells us the varition explained in
response, but penalises us for including more predictors. This reduces
the chances of over-fitting models with lots of predictors that donâ€™t
contribute much. This is the R-squared that tends to be reported in
publications.</p>
<p><code class="docutils literal notranslate"><span class="pre">F</span> <span class="pre">Statistc</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">DF</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">p-value</span></code>: The last line reports the overall
results of our model. When reporting the statistic tests in the results
section, we tend to quote these values for the model. This test is
comparing our model line against a flat horizontal line at the mean body
mass. Simply put, does our latitude model explain more of the variance
in body mass than the mean. This is easiest to explain with a quick
example:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create some data.</span>
<span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">12</span><span class="p">,</span> <span class="m">18</span><span class="p">,</span> <span class="m">21</span><span class="p">,</span> <span class="m">36</span><span class="p">,</span> <span class="m">44</span><span class="p">,</span> <span class="m">54</span><span class="p">,</span> <span class="m">59</span><span class="p">)</span>
<span class="n">y</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">7</span><span class="p">,</span> <span class="m">11</span><span class="p">,</span> <span class="m">12</span><span class="p">,</span> <span class="m">14</span><span class="p">,</span> <span class="m">15</span><span class="p">)</span>

<span class="c1"># Create a linear model based only on the mean of y.</span>
<span class="n">mean</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">y</span> <span class="o">~</span> <span class="m">1</span><span class="p">)</span>

<span class="c1"># Create a linear model where x predicts y.</span>
<span class="n">linear</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">y</span> <span class="o">~</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># Create a plot window with one row and two columns.</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">))</span>

<span class="c1"># Plot our data for the mean.</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">xlim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">60</span><span class="p">),</span> <span class="n">ylim</span> <span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">15</span><span class="p">),</span> <span class="n">main</span> <span class="o">=</span> <span class="s">&quot;Mean&quot;</span><span class="p">)</span> 

<span class="c1"># Add the line of the linear model based on the mean.</span>
<span class="nf">abline</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&quot;red&quot;</span><span class="p">)</span>

<span class="c1"># Add in lines to show the distance from each point to mean line (the residuals).</span>
<span class="nf">segments</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="nf">predict</span><span class="p">(</span><span class="n">mean</span><span class="p">))</span>

<span class="c1"># Do the same to plot our data with the linear model based on x.</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">xlim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">60</span><span class="p">),</span> <span class="n">ylim</span> <span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">15</span><span class="p">),</span> <span class="n">main</span> <span class="o">=</span> <span class="s">&quot;Linear&quot;</span><span class="p">)</span>  
<span class="nf">abline</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&quot;blue&quot;</span><span class="p">)</span>
<span class="nf">segments</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="nf">predict</span><span class="p">(</span><span class="n">linear</span><span class="p">))</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-8-1.png"><img alt="../../_images/unnamed-chunk-8-1.png" class="align-center" src="../../_images/unnamed-chunk-8-1.png" style="width: 600px;" /></a>
<p>From the plots we can see that the blue linear model line passes closer
to all of our data points than simply using the mean line. The black
lines from our data points to the linear model are the residual
variation left over once weâ€™ve accounted for x. This is often referred
to as the residuals.</p>
<p>The F statistic in our summary output is testing if there is a
siginificant difference between the residuals from using our mean line
against using our linear model instead. This is weighed up against the
number of degrees of freedom to calculate our p-value.</p>
<p>Degrees of freedom are often poorly known but are actually quite simple
to understand. They are calculated from the number of independent data
points in your model, minus the number of predictors. This is to prevent
models that over-fit the data. So models with lots of data points have
high degrees of freedom which means we need lower F statistic values to
be certain of our model. For models with few data points it depends on
the number of predictors. If thereâ€™s few predictors, like in our model,
that means that we can accept lower F statistics. We can be more
confident in our relationship if we used fewer predictors to describe
it. If we use lots of predictors, we can be less certain in our model,
because each predictor may explain some of the variation just by chance.
Therefore we need a higher F statistic. When you report your models,
report both the degrees of freedom and the F statistic alongside your
p-value for the whole model.</p>
<p>Now that we understand a bit more about our summary report, lets look at
it again to investigate the relationship between body mass and latitude.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the summary of our model.</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">duck_model</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>## 
## Call:
## lm(formula = log_BM ~ abs_latitude, data = duck_data)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -1.3202 -0.5291 -0.0613  0.3249  2.1978 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  6.505760   0.124237  52.366  &lt; 2e-16 ***
## abs_latitude 0.011639   0.002933   3.969 0.000112 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.725 on 150 degrees of freedom
## Multiple R-squared:  0.09503,    Adjusted R-squared:  0.089 
## F-statistic: 15.75 on 1 and 150 DF,  p-value: 0.0001117
</pre></div>
</div>
<p>We can see from our model that both the intercept and latitude are
significant predictors. That the intercept is significant isnâ€™t very
interesting. It means at 0 latitude (the equator), body mass is
significantly different from zero. Seeing as itâ€™s impossible to have a
species with zero body mass, this isnâ€™t surprising! Whatâ€™s more
interesting is latitude. We can see a significant p-value, so there is a
relationship between latitude and body mass. As the estimate is
positive, we can see that as latitude increases, so does body mass. For
every 1 degree of latitude, log(body mass) increases by 0.012,
supporting Bergmannâ€™s rule. We can see that by plotting our model line
with our data.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot our model.</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">log_BM</span> <span class="o">~</span> <span class="n">abs_latitude</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">duck_data</span><span class="p">)</span>
<span class="nf">abline</span><span class="p">(</span><span class="n">duck_model</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-10-11.png"><img alt="../../_images/unnamed-chunk-10-11.png" class="align-center" src="../../_images/unnamed-chunk-10-11.png" style="width: 600px;" /></a>
<p>Of course, we can see that many data points donâ€™t fit this line. If we
look at the adjusted R-squared, we can see that our model explains
roughly 9% of the variation in body size. Most macro-evolutionary
studies have low R-squared values, so this is quite high! We could
potentially increase this more by including other predictors which
influence body size. Have a think about what these predictors could be.</p>
<p>We can also see from the bottom line of output that our overall model is
significant. Because there is only one predictor (except the intercept),
this value will be the same as our p-value for body mass.</p>
<p>As weâ€™ve ran a standard linear model, we should also check our residuals
to see if they are normally distributed. This is one of the assumptions
of parametric tests, and if not we might consider using a generalised
linear model instead.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot a density curve of the residuals.</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">density</span><span class="p">(</span><span class="n">duck_model</span><span class="o">$</span><span class="n">residuals</span><span class="p">))</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-11-11.png"><img alt="../../_images/unnamed-chunk-11-11.png" class="align-center" src="../../_images/unnamed-chunk-11-11.png" style="width: 600px;" /></a>
<p>Our residuals look pretty normally distributed. Itâ€™s often good enough
just to inspect these plots by eye, to check thereâ€™s no extreme left or
right skew to the distribution.</p>
</section>
<section id="phylogenetic-generalised-least-squares-models">
<h2>3. Phylogenetic generalised least squares models<a class="headerlink" href="#phylogenetic-generalised-least-squares-models" title="Permalink to this headline">Â¶</a></h2>
<p>Up until now we have been treating all our species as independent data
points. However, technically this isnâ€™t true. Each species is related to
each other, and some are more closely related than others. We might
expect closely related species in the same genus to have a similar body
mass, compared to species from different genera. If true, it could mean
there are more large species at higher latitudes because they all shared
one common ancestor (who happened to be a large species). This would
suggest that the evolutionary history of ducks is responsible for the
patterns of body mass, rather than a true relationship between latitude
and body mass. Fortunately, we can test this using
phylogenetically-controlled linear models. One of the easiest to use is
a PGLS.</p>
<p>First letâ€™s load up the packages we need and the phylogenetic tree of
ducks.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load phylogenetic packages.</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ape</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">caper</span><span class="p">)</span>

<span class="c1"># Read in the tree.</span>
<span class="n">duck_tree</span> <span class="o">&lt;-</span> <span class="nf">read.tree</span><span class="p">(</span><span class="s">&quot;data/duck_tree.tre&quot;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">duck_tree</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">0.3</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-12-11.png"><img alt="../../_images/unnamed-chunk-12-11.png" class="align-center" src="../../_images/unnamed-chunk-12-11.png" style="width: 600px;" /></a>
<p>We now need to attach our body mass data and tree together, and we can
do this by creating a comparative data object from the <code class="docutils literal notranslate"><span class="pre">caper</span></code> package.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># We need to change the Jetz names so that they match the tip labels.</span>
<span class="n">duck_data</span><span class="o">$</span><span class="n">jetz_name</span> <span class="o">&lt;-</span> <span class="nf">gsub</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="n">duck_data</span><span class="o">$</span><span class="n">jetz_name</span><span class="p">)</span>

<span class="c1"># We specify the phylogeny we need, the data, and which column has the tip label names in.</span>
<span class="n">duck_comp</span> <span class="o">&lt;-</span> <span class="nf">comparative.data</span><span class="p">(</span><span class="n">phy</span> <span class="o">=</span> <span class="n">duck_tree</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">duck_data</span><span class="p">,</span> <span class="n">names.col</span> <span class="o">=</span> <span class="s">&quot;jetz_name&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can inspect our comparative data object to check that itâ€™s worked.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Return the data.</span>
<span class="nf">head</span><span class="p">(</span><span class="n">duck_comp</span><span class="o">$</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>##                        latitude body_mass abs_latitude   log_BM
## Dendrocygna_arborea       19.66   1150.00        19.66 7.047517
## Dendrocygna_autumnalis    -5.68    755.30         5.68 6.627115
## Dendrocygna_arcuata       -7.97    796.18         7.97 6.679825
## Dendrocygna_javanica      18.86    519.61        18.86 6.253079
## Dendrocygna_eytoni       -21.27    789.99        21.27 6.672020
## Dendrocygna_guttata       -3.41    800.00         3.41 6.684612
</pre></div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the phylogeny.</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">duck_comp</span><span class="o">$</span><span class="n">phy</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">0.3</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-15-1.png"><img alt="../../_images/unnamed-chunk-15-1.png" class="align-center" src="../../_images/unnamed-chunk-15-1.png" style="width: 600px;" /></a>
<p>So we can see that our comparative object has worked as it should. Now
we can run a pgls to see if information on the phylogeny makes any
difference.</p>
<p><strong>Warning</strong> If youâ€™re using R studio Cloud, youâ€™ll need an extra
argument: <code class="docutils literal notranslate"><span class="pre">bounds</span> <span class="pre">=</span> <span class="pre">list(lambda</span> <span class="pre">=</span> <span class="pre">c(0.05,</span> <span class="pre">1))</span></code>. So it looks like this:</p>
<p><code class="docutils literal notranslate"><span class="pre">duck_pgls</span> <span class="pre">&lt;-</span> <span class="pre">pgls(log_BM</span> <span class="pre">~</span> <span class="pre">abs_latitude,</span> <span class="pre">data</span> <span class="pre">=</span> <span class="pre">duck_comp,</span> <span class="pre">lambda</span> <span class="pre">=</span> <span class="pre">&quot;ML&quot;,</span> <span class="pre">bounds</span> <span class="pre">=</span> <span class="pre">list(lambda</span> <span class="pre">=</span> <span class="pre">c(0.05,</span> <span class="pre">1)))</span></code></p>
<p>This limits where the model searches for the lambda value, but wonâ€™t
change your result. Itâ€™s just a weird way cloud is set up, and doesnâ€™t
happen for every pgls. For your coursework, try models without this
argument first.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run a PGLS model.</span>
<span class="n">duck_pgls</span> <span class="o">&lt;-</span> <span class="nf">pgls</span><span class="p">(</span><span class="n">log_BM</span> <span class="o">~</span> <span class="n">abs_latitude</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">duck_comp</span><span class="p">,</span> <span class="n">lambda</span> <span class="o">=</span> <span class="s">&quot;ML&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The code for a pgls looks largely the same. The only difference is that
we have a third argument, which is the lambda value. The lambda value
tells us how randomly body mass and latitude are spread throughout the
tree. By saying <code class="docutils literal notranslate"><span class="pre">&quot;ML&quot;</span></code> weâ€™ve asked the function to calculate lambda
using maximum likelihood methods, rather than give it an exact value.</p>
<p>Letâ€™s take a look at the results of the pgls.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># You can see the summary the same way.</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">duck_pgls</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>## 
## Call:
## pgls(formula = log_BM ~ abs_latitude, data = duck_comp, lambda = &quot;ML&quot;)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.97464 -0.17081 -0.00968  0.11650  0.54058 
## 
## Branch length transformations:
## 
## kappa  [Fix]  : 1.000
## lambda [ ML]  : 0.983
##    lower bound : 0.000, p = &lt; 2.22e-16
##    upper bound : 1.000, p = &lt; 2.22e-16
##    95.0% CI   : (0.959, 0.993)
## delta  [Fix]  : 1.000
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  6.7827025  0.7205697  9.4130   &lt;2e-16 ***
## abs_latitude 0.0026244  0.0019744  1.3292   0.1858    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.2301 on 150 degrees of freedom
## Multiple R-squared: 0.01164, Adjusted R-squared: 0.005052 
## F-statistic: 1.767 on 1 and 150 DF,  p-value: 0.1858
</pre></div>
</div>
<p>The output of the summary look largely the same as our linear model. The
key difference is we now have information on the branch length
transformations, which shows how our trait is influenced by phylogeny.
We can also see that our p-value for latitude is now much higher, and
above the 0.05 threshold. When we look at our estimate, we can see that
itâ€™s a positive value, so the same relationship is there, but we can no
longer be confident enough to reject our null hypothesis. This is why
for macro-evolutionary studies, we always have to include information on
the phylogeny!</p>
<p>We should take a second to look at the lambda value. Ours is 0.98
according to the pgls summary. But what does it mean?</p>
<p>Lambda is scaled between 0 and 1, and itâ€™s easiest to think of it as how
much our trait is bunched up in the tree. Values closer to zero suggest
that body mass would be spread randomly among the tree, and the
phylogeny does not matter. Values closer to one suggest that body mass
is organised strongly throughout the tree, with closer species having
more similar sizes.</p>
<p>For an excellent explanation of lambda values, check out this paper by
Natalie Cooper at the Natural History Museum, who helped write the
second practical on this course.</p>
<p><a class="reference external" href="https://royalsocietypublishing.org/doi/full/10.1098/rstb.2012.0341">https://royalsocietypublishing.org/doi/full/10.1098/rstb.2012.0341</a></p>
<p>What the lambda value actually does is change the length of the branches
on the tree, to reflect how body mass is related between species. We can
visualise this by plotting trees with different lambda values.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the package geiger that has the rescale function. You&#39;ll have to install it if you&#39;re in Rstudio on your own laptops.</span>
<span class="nf">library</span><span class="p">(</span><span class="n">geiger</span><span class="p">)</span>

<span class="c1"># We&#39;ll create six trees with different lambda values .</span>
<span class="n">lambda_1_tree</span> <span class="o">&lt;-</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">duck_tree</span><span class="p">,</span> <span class="s">&quot;lambda&quot;</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
<span class="n">lambda_0.8_tree</span> <span class="o">&lt;-</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">duck_tree</span><span class="p">,</span> <span class="s">&quot;lambda&quot;</span><span class="p">,</span> <span class="m">0.8</span><span class="p">)</span>
<span class="n">lambda_0.6_tree</span> <span class="o">&lt;-</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">duck_tree</span><span class="p">,</span> <span class="s">&quot;lambda&quot;</span><span class="p">,</span> <span class="m">0.6</span><span class="p">)</span>
<span class="n">lambda_0.4_tree</span> <span class="o">&lt;-</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">duck_tree</span><span class="p">,</span> <span class="s">&quot;lambda&quot;</span><span class="p">,</span> <span class="m">0.4</span><span class="p">)</span>
<span class="n">lambda_0.2_tree</span> <span class="o">&lt;-</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">duck_tree</span><span class="p">,</span> <span class="s">&quot;lambda&quot;</span><span class="p">,</span> <span class="m">0.2</span><span class="p">)</span>
<span class="n">lambda_0_tree</span> <span class="o">&lt;-</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">duck_tree</span><span class="p">,</span> <span class="s">&quot;lambda&quot;</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>

<span class="c1"># Now we&#39;ll plot them alongside each other to see the difference.</span>

<span class="c1"># Change the number of plots and resize the window.</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">))</span>
<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="o">=</span><span class="m">15</span><span class="p">,</span> <span class="n">repr.plot.height</span><span class="o">=</span><span class="m">15</span><span class="p">)</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">lambda_1_tree</span><span class="p">,</span> <span class="n">show.tip.label</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s">&quot;downwards&quot;</span><span class="p">,</span> <span class="n">main</span> <span class="o">=</span> <span class="s">&quot;1.0&quot;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">lambda_0.8_tree</span><span class="p">,</span> <span class="n">show.tip.label</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s">&quot;downwards&quot;</span><span class="p">,</span> <span class="n">main</span> <span class="o">=</span> <span class="s">&quot;0.8&quot;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">lambda_0.6_tree</span><span class="p">,</span> <span class="n">show.tip.label</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s">&quot;downwards&quot;</span><span class="p">,</span> <span class="n">main</span> <span class="o">=</span> <span class="s">&quot;0.6&quot;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">lambda_0.4_tree</span><span class="p">,</span> <span class="n">show.tip.label</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s">&quot;downwards&quot;</span><span class="p">,</span> <span class="n">main</span> <span class="o">=</span> <span class="s">&quot;0.4&quot;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">lambda_0.2_tree</span><span class="p">,</span> <span class="n">show.tip.label</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s">&quot;downwards&quot;</span><span class="p">,</span> <span class="n">main</span> <span class="o">=</span> <span class="s">&quot;0.2&quot;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">lambda_0_tree</span><span class="p">,</span> <span class="n">show.tip.label</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s">&quot;downwards&quot;</span><span class="p">,</span> <span class="n">main</span> <span class="o">=</span> <span class="s">&quot;0.0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-18-11.png"><img alt="../../_images/unnamed-chunk-18-11.png" class="align-center" src="../../_images/unnamed-chunk-18-11.png" style="width: 600px;" /></a>
<p>Whatâ€™s actually happening is the lambda value shortens all the internal
branches (everything except the tips). This reduces the difference
between species. In the last plot we can see a lambda value of zero, and
all the branches are equally close to the root, and therefore to each
other. This means that all our species are now independent points, and
if we ran a pgls we would get similar results to a linear model. Try it
out running a pgls with different lambda values and see what happens!</p>
<p>We can plot the profile of the lambda value from our pgls and see how we
came to this number.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Change the plot margins to fit the plot in.</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mar</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">7</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">2</span><span class="p">))</span>

<span class="c1"># Get the potential values of lambda.</span>
<span class="n">lambda_likelihood</span> <span class="o">&lt;-</span> <span class="nf">pgls.profile</span><span class="p">(</span><span class="n">duck_pgls</span><span class="p">,</span> <span class="n">which</span> <span class="o">=</span> <span class="s">&quot;lambda&quot;</span><span class="p">)</span>

<span class="c1"># Plot them.</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">lambda_likelihood</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-19-1.png"><img alt="../../_images/unnamed-chunk-19-1.png" class="align-center" src="../../_images/unnamed-chunk-19-1.png" style="width: 600px;" /></a>
<p>On the horizontal axis we can see potential lambda values, and on the
vertical is how likely they are. Red lines show the 95% confidence
intervals. This shows that we are fairly confident in our lambda value.
Itâ€™s always worth plotting the our lambda profile, as a flatter line
would mean weâ€™re less confident in our lambda, and might not have
controlled for our phylogeny properly. Also be wary of smaller
phylogenies, as the lambda value is harder to estimate. Try and pick a
group with more than 100 species for your coursework just to be safe.</p>
<p>Donâ€™t worry if you struggled to understand any of this! Lambda values
can be tricky to get your head around. At this stage, itâ€™s only
important to be aware that a pgls uses a lambda value to decide how much
to weight up the importance of the phylogeny.</p>
<p>For more information on using a pgls check out this very useful papers
that are aimed at beginners. In particular chapeter 6 which you find on
researchgate:</p>
<p><a class="reference external" href="http://www.mpcm-evolution.com/book-sections/part-introduction/5-primer-phylogenetic-generalised-least-squares">http://www.mpcm-evolution.com/book-sections/part-introduction/5-primer-phylogenetic-generalised-least-squares</a></p>
<p><a class="reference external" href="http://www.mpcm-evolution.com/book-sections/part-introduction/6-statistical-issues-assumptions-phylogenetic-generalised-least-squares">http://www.mpcm-evolution.com/book-sections/part-introduction/6-statistical-issues-assumptions-phylogenetic-generalised-least-squares</a></p>
<p><a class="reference external" href="https://onlinelibrary.wiley.com/doi/full/10.1111/j.1420-9101.2009.01757.x">https://onlinelibrary.wiley.com/doi/full/10.1111/j.1420-9101.2009.01757.x</a></p>
</section>
<section id="rapoports-rule">
<h2>4. Rapoportâ€™s rule<a class="headerlink" href="#rapoports-rule" title="Permalink to this headline">Â¶</a></h2>
<p>For your coursework you might choose to investigate Rapoportâ€™s rule:
does range size increase with latitude? To do this weâ€™ll use a pgls like
the previous section. Weâ€™ll then use some of the mapping skills that we
learnt from Practical 1 to extract range size and latitude. For this
example weâ€™ll use the family Accipitridae, which includes some birds of
prey.</p>
<section id="phylogenetic-analysis">
<h3>Phylogenetic analysis<a class="headerlink" href="#phylogenetic-analysis" title="Permalink to this headline">Â¶</a></h3>
<p>First weâ€™ll load in our data. This is the same data from practical 1
from the AVONET database. The citation for this data is:</p>
<p>Tobias, J.A., Sheard, C., Pigot, A.L., Devenish, A.J.M., Yang, J.,
Sayol, F. et al.Â (2021) AVONET: morphological, ecological and
geographical data for all birds. Ecology Letters (in press).</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in the avonet data.</span>
<span class="n">avonet_data</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&quot;data/avonet_data.csv&quot;</span><span class="p">)</span>
<span class="nf">str</span><span class="p">(</span><span class="n">avonet_data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>## &#39;data.frame&#39;:    9872 obs. of  25 variables:
##  $ birdlife_name       : chr  &quot;Accipiter albogularis&quot; &quot;Accipiter badius&quot; &quot;Accipiter bicolor&quot; &quot;Accipiter brachyurus&quot; ...
##  $ birdlife_common_name: chr  &quot;Pied Goshawk&quot; &quot;Shikra&quot; &quot;Bicolored Hawk&quot; &quot;New Britain Sparrowhawk&quot; ...
##  $ jetz_name           : chr  &quot;Accipiter_albogularis&quot; &quot;Accipiter_badius&quot; &quot;Accipiter_bicolor&quot; &quot;Accipiter_brachyurus&quot; ...
##  $ jetz_order          : chr  &quot;Accipitriformes&quot; &quot;Accipitriformes&quot; &quot;Accipitriformes&quot; &quot;Accipitriformes&quot; ...
##  $ jetz_family         : chr  &quot;Accipitridae&quot; &quot;Accipitridae&quot; &quot;Accipitridae&quot; &quot;Accipitridae&quot; ...
##  $ redlist_cat         : chr  &quot;LC&quot; &quot;LC&quot; &quot;LC&quot; &quot;VU&quot; ...
##  $ beak_length_culmen  : num  27.7 20.6 25 22.5 21.1 20 20.5 19.2 20 25.4 ...
##  $ beak_length_nares   : num  17.8 12.1 13.7 14 12.1 11.9 11.5 10.6 11.2 13.9 ...
##  $ beak_width          : num  10.6 8.8 8.6 8.9 8.7 6.6 8.3 7.7 8.6 8.6 ...
##  $ beak_depth          : num  14.7 11.6 12.7 11.9 11.1 12 10.9 9.6 11 13.2 ...
##  $ tarsus_length       : num  62 43 58.1 61.2 46.4 48.7 52.6 60.3 43.6 62 ...
##  $ wing_length         : num  235 187 230 202 218 ...
##  $ kipps_distance      : num  81.8 62.5 56.6 64.1 87.8 42.9 38.9 81.3 49.5 77.8 ...
##  $ secondary1          : num  160 127 175 138 130 ...
##  $ hand_wing_index     : num  33.9 32.9 24.6 31.7 40.2 25.8 24 37.8 30 32.3 ...
##  $ tail_length         : num  169 141 186 141 154 ...
##  $ mass                : num  249 131 288 142 186 ...
##  $ habitat_density     : int  1 2 2 1 1 1 1 1 1 2 ...
##  $ migration           : int  2 3 2 2 3 1 2 2 2 3 ...
##  $ trophic_level       : chr  &quot;Carnivore&quot; &quot;Carnivore&quot; &quot;Carnivore&quot; &quot;Carnivore&quot; ...
##  $ trophic_niche       : chr  &quot;Vertivore&quot; &quot;Vertivore&quot; &quot;Vertivore&quot; &quot;Vertivore&quot; ...
##  $ primary_lifestyle   : chr  &quot;Insessorial&quot; &quot;Insessorial&quot; &quot;Generalist&quot; &quot;Insessorial&quot; ...
##  $ centroid_latitude   : num  -8.15 8.23 -10.1 -5.45 45.24 ...
##  $ centroid_longitude  : num  158.5 45 -60 150.7 45.3 ...
##  $ range_size          : num  37461 22374973 14309701 35581 2936752 ...
</pre></div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">head</span><span class="p">(</span><span class="n">avonet_data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>##           birdlife_name    birdlife_common_name             jetz_name      jetz_order  jetz_family
## 1 Accipiter albogularis            Pied Goshawk Accipiter_albogularis Accipitriformes Accipitridae
## 2      Accipiter badius                  Shikra      Accipiter_badius Accipitriformes Accipitridae
## 3     Accipiter bicolor          Bicolored Hawk     Accipiter_bicolor Accipitriformes Accipitridae
## 4  Accipiter brachyurus New Britain Sparrowhawk  Accipiter_brachyurus Accipitriformes Accipitridae
## 5    Accipiter brevipes      Levant Sparrowhawk    Accipiter_brevipes Accipitriformes Accipitridae
## 6     Accipiter butleri     Nicobar Sparrowhawk     Accipiter_butleri Accipitriformes Accipitridae
##   redlist_cat beak_length_culmen beak_length_nares beak_width beak_depth tarsus_length wing_length
## 1          LC               27.7              17.8       10.6       14.7          62.0       235.2
## 2          LC               20.6              12.1        8.8       11.6          43.0       186.7
## 3          LC               25.0              13.7        8.6       12.7          58.1       229.6
## 4          VU               22.5              14.0        8.9       11.9          61.2       202.2
## 5          LC               21.1              12.1        8.7       11.1          46.4       217.6
## 6          VU               20.0              11.9        6.6       12.0          48.7       166.0
##   kipps_distance secondary1 hand_wing_index tail_length  mass habitat_density migration trophic_level
## 1           81.8      159.5            33.9       169.0 248.8               1         2     Carnivore
## 2           62.5      127.4            32.9       140.6 131.2               2         3     Carnivore
## 3           56.6      174.8            24.6       186.3 287.5               2         2     Carnivore
## 4           64.1      138.1            31.7       140.8 142.0               1         2     Carnivore
## 5           87.8      129.9            40.2       153.5 186.5               1         3     Carnivore
## 6           42.9      123.1            25.8       127.0 122.0               1         1     Carnivore
##   trophic_niche primary_lifestyle centroid_latitude centroid_longitude  range_size
## 1     Vertivore       Insessorial             -8.15             158.49    37461.21
## 2     Vertivore       Insessorial              8.23              44.98 22374973.00
## 3     Vertivore        Generalist            -10.10             -59.96 14309701.27
## 4     Vertivore       Insessorial             -5.45             150.68    35580.71
## 5     Vertivore        Generalist             45.24              45.33  2936751.80
## 6     Vertivore       Insessorial              8.42              93.17      327.84
</pre></div>
</div>
<p>So we can see the data is a near complete species list for the worldâ€™s
birds, with some information on morphological data, range data and IUCN
categories. Weâ€™ve included two different taxonomies, Birdlife and Jetz,
however weâ€™ll just use Jetz which matches our phylogeny.</p>
<p>For more info on the tree, and where download your own in the future,
look here:</p>
<p><a class="reference external" href="http://birdtree.org/">http://birdtree.org/</a></p>
<p>So weâ€™ll first filter our traits based on the Jetz families.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the dplyr package to use filter.</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>

<span class="c1"># Filter will subset our trait data based on the Jetz family column.</span>
<span class="n">accip_data</span> <span class="o">&lt;-</span> <span class="n">avonet_data</span> <span class="o">%&gt;%</span> <span class="nf">filter</span><span class="p">(</span><span class="n">jetz_family</span> <span class="o">==</span> <span class="s">&quot;Accipitridae&quot;</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><p>Extra task: Can you use skills from Practical 2 and 3 to run a PGLS to
detirmine if Rapoportâ€™s rule is true in Accipitridae? Youâ€™ll need to
read in the â€˜all_birds.treâ€™ and drop the tips for all the other
species.</p>
</div></blockquote>
<div class="dropdown admonition">
<p class="admonition-title">Show the answerâ€¦  </p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># First we need to get absolute latitude.</span>
<span class="n">accip_data</span><span class="o">$</span><span class="n">abs_latitude</span> <span class="o">&lt;-</span> <span class="nf">abs</span><span class="p">(</span><span class="n">accip_data</span><span class="o">$</span><span class="n">centroid_latitude</span><span class="p">)</span>

<span class="c1"># Read in the tree.</span>
<span class="n">bird_tree</span> <span class="o">&lt;-</span> <span class="nf">read.tree</span><span class="p">(</span><span class="s">&quot;data/all_birds.tre&quot;</span><span class="p">)</span>

<span class="c1"># Get the tips we don&#39;t want.</span>
<span class="n">drop_tips</span> <span class="o">&lt;-</span> <span class="nf">setdiff</span><span class="p">(</span><span class="n">bird_tree</span><span class="o">$</span><span class="n">tip.label</span><span class="p">,</span> <span class="n">accip_data</span><span class="o">$</span><span class="n">jetz_name</span><span class="p">)</span>

<span class="c1"># Drop the tips.</span>
<span class="n">accip_tree</span> <span class="o">&lt;-</span> <span class="nf">drop.tip</span><span class="p">(</span><span class="n">bird_tree</span><span class="p">,</span> <span class="n">drop_tips</span><span class="p">)</span>

<span class="c1"># Create a comparative data object.</span>
<span class="n">accip_comp</span> <span class="o">&lt;-</span> <span class="nf">comparative.data</span><span class="p">(</span><span class="n">phy</span> <span class="o">=</span> <span class="n">accip_tree</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">accip_data</span><span class="p">,</span> <span class="n">names.col</span> <span class="o">=</span> <span class="s">&quot;jetz_name&quot;</span><span class="p">)</span>

<span class="c1"># Run the pgls.</span>
<span class="n">accip_pgls</span> <span class="o">&lt;-</span> <span class="nf">pgls</span><span class="p">(</span><span class="n">range_size</span> <span class="o">~</span> <span class="n">abs_latitude</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">accip_comp</span><span class="p">,</span> <span class="n">lambda</span> <span class="o">=</span> <span class="s">&quot;ML&quot;</span><span class="p">)</span>

<span class="c1"># Get the summary.</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">accip_pgls</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>## 
## Call:
## pgls(formula = range_size ~ abs_latitude, data = accip_comp, 
##     lambda = &quot;ML&quot;)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -3306385  -615255   -38880   532818  5382176 
## 
## Branch length transformations:
## 
## kappa  [Fix]  : 1.000
## lambda [ ML]  : 0.000
##    lower bound : 0.000, p = 1    
##    upper bound : 1.000, p = &lt; 2.22e-16
##    95.0% CI   : (NA, 0.140)
## delta  [Fix]  : 1.000
## 
## Coefficients:
##              Estimate Std. Error t value  Pr(&gt;|t|)    
## (Intercept)   4384350     654706  6.6967 1.556e-10 ***
## abs_latitude    71425      27595  2.5884   0.01024 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 995300 on 235 degrees of freedom
## Multiple R-squared: 0.02772, Adjusted R-squared: 0.02358 
## F-statistic:   6.7 on 1 and 235 DF,  p-value: 0.01024
</pre></div>
</div>
<p>So it looks like Rapoportâ€™s rule is true for Accipitridae! But there are
some interesting values in the summary worth discussing. What does a
lambda value of zero mean? Try running a normal linear model to see if
there are any differences. We can also plot lambda again.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Change the plot margins to fit the plot in.</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mar</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">7</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">2</span><span class="p">))</span>

<span class="c1"># Get the potential values of lambda.</span>
<span class="n">lambda_likelihood</span> <span class="o">&lt;-</span> <span class="nf">pgls.profile</span><span class="p">(</span><span class="n">accip_pgls</span><span class="p">,</span> <span class="n">which</span> <span class="o">=</span> <span class="s">&quot;lambda&quot;</span><span class="p">)</span>

<span class="c1"># Plot them.</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">lambda_likelihood</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-23-11.png"><img alt="../../_images/unnamed-chunk-23-11.png" class="align-center" src="../../_images/unnamed-chunk-23-11.png" style="width: 600px;" /></a>
<p>So the curve for lambda is flatter than for our Bergmannâ€™s rule
analysis, but itâ€™s still steep enough to be confident weâ€™ve got the
right lambda value. If we wanted to be very sure, we could redo our pgls
with <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">=</span> <span class="pre">0.15</span></code> to check if it changes our result.</p>
</div>
</section>
<section id="plotting-range-size">
<h3>Plotting range size<a class="headerlink" href="#plotting-range-size" title="Permalink to this headline">Â¶</a></h3>
<p>Now we need to load in our range data. For convenience weâ€™ve saved the
range data as an <code class="docutils literal notranslate"><span class="pre">.Rdata</span></code> object, which <code class="docutils literal notranslate"><span class="pre">R</span></code> can load back into the
working environment. <code class="docutils literal notranslate"><span class="pre">.Rdata</span></code> objects can be extremely useful,
especially when youâ€™ve ran a model thatâ€™s taken a long time, and wish to
save the result without converting it to a specific file format. The
maps for each family are available as a separate <code class="docutils literal notranslate"><span class="pre">R.data</span></code> file on
blackboard.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># First load in the spatial packages we&#39;ll need.</span>
<span class="nf">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>


<span class="c1"># Load the data into our environment.</span>
<span class="nf">load</span><span class="p">(</span><span class="s">&quot;data/accipitridae_ranges.RData&quot;</span><span class="p">)</span>

<span class="c1"># Inspect the maps.</span>
<span class="nf">class</span><span class="p">(</span><span class="n">accip_ranges</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">accip_ranges</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>## [1] &quot;sf&quot;         &quot;data.frame&quot;
## Simple feature collection with 6 features and 3 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -17.53522 ymin: -29.47375 xmax: 167.2831 ymax: 55.85556
## Geodetic CRS:  WGS 84
##             ID               SCINAME DATE_                          Shape
## 10764 22695535 Accipiter_albogularis  2014 MULTIPOLYGON (((167.2819 -9...
## 1     22695490      Accipiter_badius  2013 MULTIPOLYGON (((-17.4704 14...
## 14087 22695605  Accipiter_brachyurus  2018 MULTIPOLYGON (((152.9669 -4...
## 13013 22695499    Accipiter_brevipes  2009 MULTIPOLYGON (((19.3891 39....
## 10777 22695494     Accipiter_butleri  2014 MULTIPOLYGON (((93.531 8.01...
## 6618  22695486 Accipiter_castanilius  2013 MULTIPOLYGON (((7.090881 6....
</pre></div>
</div>
<p>As a reminder from practical 1, we can see that the range maps are
stored in a spatial dataframe, called and <code class="docutils literal notranslate"><span class="pre">sf</span></code> class of object. We can
plot the polygons again to see what they look like.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#  Take the range polygon from the first row.</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">accip_ranges</span><span class="o">$</span><span class="n">Shape</span><span class="p">[</span><span class="m">1</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-25-1.png"><img alt="../../_images/unnamed-chunk-25-1.png" class="align-center" src="../../_images/unnamed-chunk-25-1.png" style="width: 600px;" /></a>
<p>We can then plot the range sizes to view them at a global scale. For
this practical weâ€™ll split ranges in small and large, and highlight the
smaller ranges on the map. To do this we need to utilise a <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">loop</span></code>
and an <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">statement</span></code> to decide if each range size is bigger than
1,000,000 km<sup>2</sup>. This value works well for accipitridae with
large ranges, but for your own clade you may wish to choose a smaller
value to best show the data. There is no correct value, as itâ€™s all
about data presentation.</p>
<p>Weâ€™ll now try using a <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">loop</span></code> and <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">statement</span></code>, and explain the
code in more detail below. Donâ€™t worry if it seems complicated! Hereâ€™s a
cute example from <a class="reference external" href="https://github.com/allisonhorst/stats-illustrations">Allison
Horst</a>, who does
loads of cool stats illustrations to help understand bits of ecology and
coding.</p>
<a class="reference internal image-reference" href="../../_images/monster_for_loop.png"><img alt="../../_images/monster_for_loop.png" class="align-center" src="../../_images/monster_for_loop.png" style="width: 600px;" /></a>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># And lets add a column to our data for storing if it&#39;s a small or large range.</span>
<span class="n">accip_data</span><span class="o">$</span><span class="n">range_large</span> <span class="o">&lt;-</span> <span class="kc">NA</span>

<span class="c1"># We&#39;ll use a basic loop that goes from 1 to 237.</span>
<span class="n">row_numbers</span> <span class="o">&lt;-</span> <span class="m">1</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">accip_data</span><span class="p">)</span>

<span class="c1"># The curly brackets show the beginning and the end of the loop.</span>
<span class="nf">for </span><span class="p">(</span><span class="n">x</span> <span class="n">in</span> <span class="n">row_numbers</span><span class="p">){</span>
  
  <span class="c1"># Pull out the range size we want for each iteration (x) of the loop.</span>
  <span class="n">range</span> <span class="o">&lt;-</span> <span class="n">accip_data</span><span class="o">$</span><span class="n">range_size</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
  
  <span class="c1"># Calculate if it&#39;s small range or a large range.</span>
  <span class="nf">if </span><span class="p">(</span><span class="n">range</span> <span class="o">&gt;</span> <span class="m">1000000</span><span class="p">){</span>
    <span class="n">range_large</span> <span class="o">&lt;-</span> <span class="m">1</span>
  <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
    <span class="n">range_large</span> <span class="o">&lt;-</span> <span class="m">0</span>
  <span class="p">}</span>
  
  <span class="c1"># Lastly we want to add our new value to the dataframe.</span>
  <span class="n">accip_data</span><span class="o">$</span><span class="n">range_large</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">range_large</span>
<span class="p">}</span>
</pre></div>
</div>
<p>IF functions have a logical expression inside the brackets. If itâ€™s TRUE
it will run the line between the curly brackets. If itâ€™s FALSE, it will
run whatâ€™s inside <code class="docutils literal notranslate"><span class="pre">else{}</span></code>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can also run each line of a loop one by one to better understand whatâ€™s happening.
Just set <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&lt;-</span> <span class="pre">1</span></code> and then skip the for() line to see the other lines one at a time.</p>
</div>
<p>To plot the ranges weâ€™re going to convert our sf dataframe of polygons
into a raster image, like we did in Practical 1. For <code class="docutils literal notranslate"><span class="pre">fasterize</span></code>, weâ€™ll
ask the function to take the minimum value so that small ranges are on
top of big ones. certain values, such as range_size.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load fasterize package.</span>
<span class="nf">library</span><span class="p">(</span><span class="n">fasterize</span><span class="p">)</span>

<span class="c1"># Combine the two datasets into one object so we have range size info and the polygons together. </span>
<span class="c1"># This turns our sf object into a normal dataframe.</span>
<span class="n">Accip_all</span> <span class="o">&lt;-</span> <span class="nf">left_join</span><span class="p">(</span><span class="n">accip_data</span><span class="p">,</span> <span class="n">accip_ranges</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;jetz_name&quot;</span> <span class="o">=</span> <span class="s">&quot;SCINAME&quot;</span><span class="p">))</span>

<span class="c1"># Start by creating an empty raster stack to store our data in.</span>
<span class="n">raster_template</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="m">2160</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="m">900</span><span class="p">,</span> <span class="n">ymn</span> <span class="o">=</span> <span class="m">-60</span><span class="p">)</span>

<span class="c1"># &#39;fasterize&#39; needs objects to be an sf class so we&#39;ll convert it back.</span>
<span class="n">Accip_all</span> <span class="o">&lt;-</span> <span class="nf">st_sf</span><span class="p">(</span><span class="n">Accip_all</span><span class="p">)</span>

<span class="c1"># Use the fasterize function with the raster template. We want to use the </span>
<span class="c1"># range_large field, and the function min takes the smallest value when they overlap. </span>
<span class="c1"># (so small ranges are shown on top of large ranges)</span>
<span class="n">range_raster</span> <span class="o">&lt;-</span> <span class="nf">fasterize</span><span class="p">(</span><span class="n">Accip_all</span><span class="p">,</span> <span class="n">raster_template</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="s">&quot;range_large&quot;</span><span class="p">,</span> <span class="n">fun</span> <span class="o">=</span> <span class="s">&quot;min&quot;</span><span class="p">)</span>

<span class="c1"># Plot the new map.</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">range_raster</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="nf">rainbow</span><span class="p">(</span><span class="m">2</span><span class="p">))</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-29-11.png"><img alt="../../_images/unnamed-chunk-29-11.png" class="align-center" src="../../_images/unnamed-chunk-29-11.png" style="width: 600px;" /></a>
<p>So now we can see where all the small range sizes are relative to the
large ones. However, it doesnâ€™t look very pretty and countries without
any ranges are left off the map. We can make a much clearer map using
<code class="docutils literal notranslate"><span class="pre">ggplot2</span></code>.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>

<span class="c1"># Convert the raster into a raster dataframe.</span>
<span class="n">raster_data</span> <span class="o">&lt;-</span> <span class="nf">as.data.frame</span><span class="p">(</span><span class="n">range_raster</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">drop_na</span><span class="p">()</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">raster_data</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;long&quot;</span><span class="p">,</span> <span class="s">&quot;lat&quot;</span><span class="p">,</span> <span class="s">&quot;index&quot;</span><span class="p">)</span>

<span class="c1"># Add labels for the range sizes so that ggplot colours them as discrete, rather than a continuous number.</span>
<span class="n">raster_data</span><span class="o">$</span><span class="n">ranges</span><span class="p">[</span><span class="n">raster_data</span><span class="o">$</span><span class="n">index</span> <span class="o">==</span> <span class="m">0</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s">&quot;Small&quot;</span>
<span class="n">raster_data</span><span class="o">$</span><span class="n">ranges</span><span class="p">[</span><span class="n">raster_data</span><span class="o">$</span><span class="n">index</span> <span class="o">==</span> <span class="m">1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s">&quot;Large&quot;</span>

<span class="c1"># We can then plot this in ggplot. We have to first create the colour scheme for our map.</span>
<span class="n">myColors</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;grey80&quot;</span><span class="p">,</span> <span class="s">&quot;red&quot;</span><span class="p">)</span>

<span class="c1"># Assign names to these colors that correspond to each range size.</span>
<span class="nf">names</span><span class="p">(</span><span class="n">myColors</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">unique</span><span class="p">(</span><span class="n">raster_data</span><span class="o">$</span><span class="n">ranges</span><span class="p">)</span>

<span class="c1"># Create the colour scale.</span>
<span class="n">colScale</span> <span class="o">&lt;-</span> <span class="nf">scale_fill_manual</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Range Sizes&quot;</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">myColors</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a plot with ggplot (the plus signs at the end of a line carry over to the next line).</span>
<span class="n">range_plot</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">()</span> <span class="o">+</span>
  <span class="c1"># borders imports all the country outlines onto the map. </span>
  <span class="c1"># colour changes the colour of the outlines, </span>
  <span class="c1"># fill changes the colour of the insides of the countries.</span>
  <span class="c1"># This will grey out any terrestrial area which isn&#39;t part of a range.</span>
  <span class="nf">borders</span><span class="p">(</span><span class="n">ylim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">-60</span><span class="p">,</span><span class="m">90</span><span class="p">),</span> <span class="n">fill</span> <span class="o">=</span> <span class="s">&quot;grey90&quot;</span><span class="p">,</span> <span class="n">colour</span> <span class="o">=</span> <span class="s">&quot;grey90&quot;</span><span class="p">)</span> <span class="o">+</span>
  
  <span class="c1"># Borders() xlim is -160/200 to catch the edge of Russia. We need to reset the </span>
  <span class="c1"># xlim to -180/180 to fit our raster_stack.</span>
  <span class="nf">xlim</span><span class="p">(</span><span class="m">-180</span><span class="p">,</span> <span class="m">180</span><span class="p">)</span> <span class="o">+</span> 
  
  <span class="c1"># Add the range information on top.</span>
  <span class="nf">geom_tile</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">long</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span> <span class="n">ranges</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">raster_data</span><span class="p">)</span> <span class="o">+</span>
  <span class="c1"># Add colours.</span>
  <span class="n">colScale</span> <span class="o">+</span>
  <span class="c1"># Add title.</span>
  <span class="nf">ggtitle</span><span class="p">(</span><span class="s">&quot;Small range sizes in the Accipitidae&quot;</span><span class="p">)</span> <span class="o">+</span> 
  <span class="c1"># Add the classic theme (things like gridlines, font etc.)</span>
  <span class="nf">theme_classic</span><span class="p">()</span> <span class="o">+</span>
  <span class="c1"># Add axes labels.</span>
  <span class="nf">ylab</span><span class="p">(</span><span class="s">&quot;Latitude&quot;</span><span class="p">)</span> <span class="o">+</span> 
  <span class="nf">xlab</span><span class="p">(</span><span class="s">&quot;Longitude&quot;</span><span class="p">)</span> <span class="o">+</span> 
  <span class="c1"># coord_fixed() makes ggplot keep our aspect ratio the same.</span>
  <span class="nf">coord_fixed</span><span class="p">()</span> 

<span class="c1"># Return the plot so we can view it.</span>
<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="o">=</span><span class="m">15</span><span class="p">,</span> <span class="n">repr.plot.height</span><span class="o">=</span><span class="m">10</span><span class="p">)</span>
<span class="n">range_plot</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-31-1.png"><img alt="../../_images/unnamed-chunk-31-1.png" class="align-center" src="../../_images/unnamed-chunk-31-1.png" style="width: 600px;" /></a>
<p>That looks much better than the first. Experiment with your own maps to
create a map for your report. Try changing how you show ranges, such as
what determines if a range is large or small, or anything else you can
think of! You can save your plots as a file using different formats like
a jpeg. Watch out for how the map transforms when itâ€™s saved and edit
your plots accordingly.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open up a new plotting device which will save a photo.</span>
<span class="nf">jpeg</span><span class="p">(</span><span class="s">&quot;my_map.jpeg&quot;</span><span class="p">)</span>

<span class="c1"># Add the plot to the plotting device.</span>
<span class="n">range_plot</span>

<span class="c1"># Turn off the plotting device to save it.</span>
<span class="nf">dev.off</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>## RStudioGD 
##         2
</pre></div>
</div>
</section>
</section>
<section id="latitudinal-diversity-gradient">
<h2>5. Latitudinal diversity gradient<a class="headerlink" href="#latitudinal-diversity-gradient" title="Permalink to this headline">Â¶</a></h2>
<p>Another question you might pick for your coursework is to investigate
the latitudinal diversity gradient for your chosen taxa. Weâ€™ll explore
the same relationship with Accipitridae. Weâ€™ve already extracted
latitude but we for this model we will lump species into bins at 5
degree latitudes and see if some bins are bigger closer to the equator.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># First lets create a bin range (from 0 to 90 which is max latitude) and size (by=5).</span>
<span class="n">range</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">90</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="m">5</span><span class="p">)</span> 

<span class="c1"># Create labels for our bins. We want to skip zero, as the labels refer to the upper limits of each break. </span>
<span class="n">labels</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">5</span><span class="p">,</span> <span class="m">90</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span>

<span class="c1"># We can now &#39;cut&#39; up our latitude and put them into bins. </span>
<span class="c1"># This function adds an extra column, and adds a label for which bin each species should be in.</span>
<span class="n">accip_data</span><span class="o">$</span><span class="n">lat.bins</span> <span class="o">&lt;-</span> <span class="nf">cut</span><span class="p">(</span><span class="n">accip_data</span><span class="o">$</span><span class="n">abs_latitude</span><span class="p">,</span> <span class="n">breaks</span><span class="o">=</span><span class="n">range</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span> 

<span class="c1"># The cut function creates the labels as factors, so we&#39;ll turn them back into numbers to plot. </span>
<span class="c1"># We turn them into characters first because as.numeric will convert factors into their level order, </span>
<span class="c1"># rather than their value.</span>
<span class="n">accip_data</span><span class="o">$</span><span class="n">lat.bins</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">accip_data</span><span class="o">$</span><span class="n">lat.bins</span><span class="p">))</span>

<span class="c1"># Plot our bins as a histogram</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">accip_data</span><span class="o">$</span><span class="n">lat.bins</span><span class="p">,</span> <span class="n">breaks</span> <span class="o">=</span> <span class="m">7</span><span class="p">)</span> 
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-33-1.png"><img alt="../../_images/unnamed-chunk-33-1.png" class="align-center" src="../../_images/unnamed-chunk-33-1.png" style="width: 600px;" /></a>
<p>It definitely looks like a pattern is going on there! We can investigate
this using a model.</p>
<section id="generalised-linear-models">
<h3>Generalised linear models<a class="headerlink" href="#generalised-linear-models" title="Permalink to this headline">Â¶</a></h3>
<p>Because the data is count, it looks like it has a poisson distribution.
For this reason we might want to utilise a generalised linear model
instead. Also because weâ€™ve binned species, we wonâ€™t use a pgls for this
question. First letâ€™s generate species richness.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the frequency of each bin</span>
<span class="n">species_richness</span> <span class="o">&lt;-</span> <span class="nf">count</span><span class="p">(</span><span class="n">accip_data</span><span class="p">,</span> <span class="n">lat.bins</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">species_richness</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s">&quot;richness&quot;</span>
<span class="n">species_richness</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>##    lat.bins richness
## 1         5       57
## 2        10       59
## 3        15       19
## 4        20       18
## 5        25       24
## 6        30       13
## 7        35        9
## 8        40        4
## 9        45       11
## 10       50        9
## 11       55        9
## 12       60        4
## 13       70        1
</pre></div>
</div>
<p>Now to run a glm, using a poisson error structure given our data is very
skewed.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># The only difference with running a glm is now we have to specify the family as well.</span>
<span class="n">accip_model</span> <span class="o">&lt;-</span> <span class="nf">glm</span><span class="p">(</span><span class="n">richness</span> <span class="o">~</span> <span class="n">lat.bins</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">species_richness</span><span class="p">,</span> <span class="n">family</span> <span class="o">=</span> <span class="s">&quot;poisson&quot;</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">accip_model</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>## 
## Call:
## glm(formula = richness ~ lat.bins, family = &quot;poisson&quot;, data = species_richness)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.6681  -0.9765   0.2406   1.2114   2.3963  
## 
## Coefficients:
##              Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)  4.245447   0.108752   39.04   &lt;2e-16 ***
## lat.bins    -0.049699   0.004366  -11.38   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 194.745  on 12  degrees of freedom
## Residual deviance:  29.126  on 11  degrees of freedom
## AIC: 88.839
## 
## Number of Fisher Scoring iterations: 4
</pre></div>
</div>
<p>You should be able to figure out if thereâ€™s a relationship there! One
thing to remember about a glm is that weâ€™ve applied a link function. For
a poisson model this is a log-link function. This means that the
relationship between our variables isnâ€™t as simple as a 0.05 decrease in
species richness with 1 degree of latitude. A log-link function takes a
log of the entire right side of the model formula. For interpretation,
we first need to back-transform the equation and write out our model as:</p>
<div class="math notranslate nohighlight">
\[Richness \sim e^{(4.232\ -\ 0.049\ \times lat.bins)}\]</div>
<p>Because of the law of exponents, we can rearrange it to:</p>
<div class="math notranslate nohighlight">
\[Richness \sim \frac{e^{4.232}} {e^{0.049 \times lat.bins}}  \]</div>
<p>The top half of the fraction is the intercept, which simplifies to
approximately 69. This is the predicted species richness at the equator.
Weâ€™re more interested in the change with latitude so we can simplify the
bottom. We sub in <code class="docutils literal notranslate"><span class="pre">1</span></code> for <code class="docutils literal notranslate"><span class="pre">lat.bins</span></code> to know the change with every 1
degree. This gives us 1.05 on the bottom. Dividing by 1.05 is the same
as a decrease of 5%. Therefore, for every increase of 1 degree of
latitude, there is a 5% decrease in species richness (starting from the
equator at 69). We can see this relationship by plotting our model.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># We first plot raw values as just a scatter plot.</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">richness</span> <span class="o">~</span> <span class="n">lat.bins</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">species_richness</span><span class="p">)</span>

<span class="c1"># And then add a line of the fitted values of the model.</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">species_richness</span><span class="o">$</span><span class="n">lat.bins</span><span class="p">,</span> <span class="n">accip_model</span><span class="o">$</span><span class="n">fitted.values</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-38-11.png"><img alt="../../_images/unnamed-chunk-38-11.png" class="align-center" src="../../_images/unnamed-chunk-38-11.png" style="width: 600px;" /></a>
<p>Donâ€™t worry if that seems confusing! Itâ€™s initially quite hard to
understand, but in the plot you can see that thereâ€™s roughly a 5%
decrease in species richness with every 1 degree latitude increase. For
most macro-ecological research weâ€™re less concerned with predictions,
and more interested in determining if we can reject our null hypothesis.</p>
<blockquote>
<div><p>Extra task: Can you recreate this plot using your <code class="docutils literal notranslate"><span class="pre">ggplot2</span></code> skills?</p>
</div></blockquote>
<div class="dropdown admonition">
<p class="admonition-title">Show the answerâ€¦  </p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># We need the predictions from our model. Type &quot;response&quot; gives us y after the log-link.</span>
<span class="n">predictions</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">accip_model</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;response&quot;</span><span class="p">,</span> <span class="n">se.fit</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>

<span class="c1"># Add the predictions to our dataframe.</span>
<span class="n">species_richness</span><span class="o">$</span><span class="n">fit</span> <span class="o">&lt;-</span> <span class="n">predictions</span><span class="o">$</span><span class="n">fit</span>
<span class="n">species_richness</span><span class="o">$</span><span class="n">y_max</span> <span class="o">&lt;-</span> <span class="n">predictions</span><span class="o">$</span><span class="n">fit</span> <span class="o">+</span> <span class="n">predictions</span><span class="o">$</span><span class="n">se.fit</span>
<span class="n">species_richness</span><span class="o">$</span><span class="n">y_min</span> <span class="o">&lt;-</span> <span class="n">predictions</span><span class="o">$</span><span class="n">fit</span> <span class="o">-</span> <span class="n">predictions</span><span class="o">$</span><span class="n">se.fit</span>

<span class="c1"># Create a normal scatter plot.</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">species_richness</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">lat.bins</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">richness</span><span class="p">))</span> <span class="o">+</span> <span class="nf">geom_point</span><span class="p">()</span> <span class="o">+</span>
  
  <span class="c1"># Add in the main model line. Turn se off so we add it manually after.</span>
  <span class="nf">geom_smooth</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">fit</span><span class="p">),</span> <span class="n">fullrange</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="o">+</span> 
  
  <span class="c1"># Now add the standard errors.</span>
  <span class="nf">geom_ribbon</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">y_max</span><span class="p">),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="m">0.2</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="s">&quot;blue&quot;</span><span class="p">)</span> <span class="o">+</span>
  
  <span class="c1"># Add labels.</span>
  <span class="nf">xlab</span><span class="p">(</span><span class="s">&quot;Latitude&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">ylab</span><span class="p">(</span><span class="s">&quot;Species Richness&quot;</span><span class="p">)</span> <span class="o">+</span>
  
  <span class="c1"># Lastly add a theme to remove the grey background and grid lines.</span>
  <span class="nf">theme_classic</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-39-1.png"><img alt="../../_images/unnamed-chunk-39-1.png" class="align-center" src="../../_images/unnamed-chunk-39-1.png" style="width: 600px;" /></a>
<p>Think how you could change the plot to make it nicer. Can you figure out
how to change the font sizes? Does adding more bins for latitude change
your model results, or make the plot nicer?</p>
</div>
</section>
<section id="plotting-species-richness">
<h3>Plotting species richness<a class="headerlink" href="#plotting-species-richness" title="Permalink to this headline">Â¶</a></h3>
<p>Lastly, you might also want to plot a map of species richness to go
alongside your plot. This is the map we made in practical 1. We can make
the same map using a different colour scheme.</p>
<p>For this we just use the fasterize function again, but this time we
leave out the field arguement. This means fasterize will count every
range as 1, and will sum them where they overlap to get species
richness.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the fasterize function with the raster template, summing species for species richness.</span>
<span class="n">SR_raster</span> <span class="o">&lt;-</span> <span class="nf">fasterize</span><span class="p">(</span><span class="n">Accip_all</span><span class="p">,</span> <span class="n">raster_template</span><span class="p">,</span> <span class="n">fun</span> <span class="o">=</span> <span class="s">&quot;sum&quot;</span><span class="p">)</span>

<span class="c1"># Convert the raster into a raster dataframe.</span>
<span class="n">raster_data</span> <span class="o">&lt;-</span> <span class="nf">as.data.frame</span><span class="p">(</span><span class="n">SR_raster</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">drop_na</span><span class="p">()</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">raster_data</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;long&quot;</span><span class="p">,</span> <span class="s">&quot;lat&quot;</span><span class="p">,</span> <span class="s">&quot;richness&quot;</span><span class="p">)</span>

<span class="c1"># Plot with ggplot.</span>
<span class="n">richness_plot</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">()</span> <span class="o">+</span>
  <span class="nf">borders</span><span class="p">(</span><span class="n">ylim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">-60</span><span class="p">,</span><span class="m">90</span><span class="p">),</span> <span class="n">fill</span> <span class="o">=</span> <span class="s">&quot;grey90&quot;</span><span class="p">,</span> <span class="n">colour</span> <span class="o">=</span> <span class="s">&quot;grey90&quot;</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">xlim</span><span class="p">(</span><span class="m">-180</span><span class="p">,</span> <span class="m">180</span><span class="p">)</span> <span class="o">+</span> 
  <span class="nf">geom_tile</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">long</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span> <span class="n">richness</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">raster_data</span><span class="p">)</span> <span class="o">+</span>
  
  <span class="c1"># Here we add a name to the legend, and set manual colours for either end of a gradient.</span>
  <span class="nf">scale_fill_gradientn</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Species Richness&quot;</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;skyblue&quot;</span><span class="p">,</span> <span class="s">&quot;red&quot;</span><span class="p">))</span> <span class="o">+</span>
  
  <span class="c1"># You should be getting used to this code!</span>
  <span class="nf">ggtitle</span><span class="p">(</span><span class="s">&quot;Accipitridae Species Richness Heat Map&quot;</span><span class="p">)</span> <span class="o">+</span> 
  <span class="nf">theme_classic</span><span class="p">()</span> <span class="o">+</span>
  <span class="nf">ylab</span><span class="p">(</span><span class="s">&quot;Latitude&quot;</span><span class="p">)</span> <span class="o">+</span> 
  <span class="nf">xlab</span><span class="p">(</span><span class="s">&quot;Longitude&quot;</span><span class="p">)</span> <span class="o">+</span> 
  <span class="nf">coord_fixed</span><span class="p">()</span>

<span class="c1"># Return the plot so we can view it.</span>
<span class="n">richness_plot</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/unnamed-chunk-40-1.png"><img alt="../../_images/unnamed-chunk-40-1.png" class="align-center" src="../../_images/unnamed-chunk-40-1.png" style="width: 600px;" /></a>
<p>Does this look nicer than the plot in practical 1? Figure presentation
is an important skill in ecology (and wider science), and will be useful
for your future projects no matter what the topic! Itâ€™s worth taking the
time now to play around with different colour schemes, and learn how to
edit figures using ggplot. I highly recommend checking out this page for
more information on how to effectively use colours, including links for
figure presentation in general.</p>
<p><a class="reference external" href="https://www.molecularecologist.com/2020/04/23/simple-tools-for-mastering-color-in-scientific-figures/">https://www.molecularecologist.com/2020/04/23/simple-tools-for-mastering-color-in-scientific-figures/</a></p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./markdowns/practical_3"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="../practical_2/practical_2.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Phylogenetics in R</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../practical_4/practical_4.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Setting conservation priorities</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>